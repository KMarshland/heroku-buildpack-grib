#!/usr/bin/env bash

# Check if it's already installed
if which "$grib_info" > /dev/null; then
  echo "GRIB API v$(grib_info -v) already installed"
  exit 0
fi

####
# Install cmake
# All credit to https://github.com/rcaught/heroku-buildpack-cmake/blob/master/bin/compile

echo "-----> Installing cmake"

# change to the the BUILD_DIR ($1)
cd $1

# download
curl https://s3.amazonaws.com/mergeguard/cmake.tar.gz -s -O

# make dir
mkdir -p /tmp/codon/vendor

# untar the binary to the directory we want
tar -C /tmp/codon/vendor -xvf cmake.tar.gz

debug=`ls /tmp/codon/vendor/bin`
echo $debug

####

echo ""
echo "-----> Installing grib"

BUILD_DIR=$1
CACHE_DIR=$2

mkdir -p $BUILD_DIR/grib-tools
cd $BUILD_DIR/grib-tools

# install it
curl 'https://software.ecmwf.int/wiki/download/attachments/3473437/grib_api-1.22.0-Source.tar.gz?api=v2' > grib.tar.gz && \
    mkdir grib && \
    tar -xzf grib.tar.gz -C grib --strip-components 1 && \
    rm grib.tar.gz && \
    mkdir build && \
    cd build && \
    cmake ../grib -DENABLE_GRIB_THREADS=ON -DENABLE_FORTRAN=OFF -DENABLE_PYTHON=OFF -DENABLE_JPG=OFF -DENABLE_NETCDF=OFF -DCMAKE_INSTALL_PREFIX=$BUILD_DIR/grib-tools && \
    make && make install && \
    cd ..

# add it to the PATH
BUILDPACK_DIR="$(dirname $(dirname $0))"
mkdir -p $BUILD_DIR/.profile.d
cp "$BUILDPACK_DIR/bin/set-path.sh" $BUILD_DIR/.profile.d/
chmod +x $BUILD_DIR/.profile.d/set-path.sh


echo "-----> Installed GRIB API v$($BUILD_DIR/grib-tools/build/bin/grib_info -v)"
